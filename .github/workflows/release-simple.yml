name: ðŸš€ Simple Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.2.0)'
        required: true
        type: string

env:
  DOTNET_VERSION: '6.0.x'
  LIDARR_DOCKER_VERSION: 'pr-plugins-2.13.3.4692'

permissions:
  contents: write  # Required for creating releases

jobs:
  release:
    name: ðŸ“¦ Build and Release
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get Version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Building version: ${VERSION}"

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'

    - name: Extract Lidarr Assemblies
      run: |
        echo "ðŸ³ Extracting Lidarr assemblies from Docker..."

        # Pull plugins branch Docker image
        docker pull ghcr.io/hotio/lidarr:$LIDARR_DOCKER_VERSION
        docker create --name temp-lidarr ghcr.io/hotio/lidarr:$LIDARR_DOCKER_VERSION

        # Create output directory
        mkdir -p ext/Lidarr/_output/net6.0

        # Extract required assemblies
        docker cp temp-lidarr:/app/bin/Lidarr.dll ext/Lidarr/_output/net6.0/
        docker cp temp-lidarr:/app/bin/Lidarr.Common.dll ext/Lidarr/_output/net6.0/
        docker cp temp-lidarr:/app/bin/Lidarr.Core.dll ext/Lidarr/_output/net6.0/
        docker cp temp-lidarr:/app/bin/Lidarr.Http.dll ext/Lidarr/_output/net6.0/
        docker cp temp-lidarr:/app/bin/Lidarr.Api.V1.dll ext/Lidarr/_output/net6.0/

        # Cleanup
        docker rm temp-lidarr
        echo "âœ… Assemblies extracted"

    - name: Build Plugin
      run: |
        echo "ðŸ”¨ Building Brainarr plugin..."
        dotnet restore Brainarr.sln
        dotnet build Brainarr.Plugin/Brainarr.Plugin.csproj --configuration Release --no-restore \
          -p:LidarrPath="${{ github.workspace }}/ext/Lidarr/_output/net6.0"
        echo "âœ… Build completed"

    - name: Create Release Package
      run: |
        echo "ðŸ“¦ Creating release package..."

        # Create release directory
        mkdir -p release/Brainarr

        # Copy plugin files (following TypNull's pattern)
        cp Brainarr.Plugin/bin/Lidarr.Plugin.Brainarr.dll release/Brainarr/
        cp Brainarr.Plugin/bin/Lidarr.Plugin.Brainarr.pdb release/Brainarr/ 2>/dev/null || true

        # Copy plugin manifest
        cp plugin.json release/Brainarr/

        # Copy dependencies if they exist
        for dll in Newtonsoft.Json NLog FluentValidation; do
          find Brainarr.Plugin/bin/ -name "${dll}.dll" -exec cp {} release/Brainarr/ \; 2>/dev/null || true
        done

        # Copy documentation
        cp README.md release/
        cp LICENSE release/

        # Create simple installation instructions
        cat > release/INSTALL.txt << 'EOF'
        Brainarr Plugin Installation
        ============================

        For Docker (Recommended):
        1. Use Hotio's Lidarr image: ghcr.io/hotio/lidarr:pr-plugins
        2. Copy the Brainarr folder to /config/plugins/
        3. Restart container

        For Native Installation:
        1. Switch Lidarr to "plugins" branch in Settings > General
        2. Copy the Brainarr folder to:
           - Windows: %ProgramData%\Lidarr\plugins\
           - Linux: /var/lib/lidarr/plugins/
           - macOS: ~/.config/Lidarr/plugins/
        3. Restart Lidarr

        Configuration:
        1. Go to Settings > Import Lists
        2. Add "Brainarr AI Music Discovery"
        3. Configure your preferred AI provider

        Minimum Lidarr Version: 2.13.1.4681
        EOF

        # Create ZIP (following TypNull's naming pattern)
        cd release
        zip -r ../Brainarr-${{ steps.version.outputs.version }}.net6.0.zip .
        cd ..

        # Create checksum
        sha256sum Brainarr-${{ steps.version.outputs.version }}.net6.0.zip > Brainarr-${{ steps.version.outputs.version }}.net6.0.zip.sha256

        echo "âœ… Package created: Brainarr-${{ steps.version.outputs.version }}.net6.0.zip"

    - name: Generate Release Notes
      id: notes
      run: |
        cat > release_notes.md << 'EOF'
        ## ðŸ§  Brainarr ${{ steps.version.outputs.version }}

        AI-powered music discovery plugin for Lidarr with support for 8+ AI providers.

        ### ðŸ“¦ Installation

        **Docker (Recommended):**
        ```yaml
        image: ghcr.io/hotio/lidarr:pr-plugins
        ```

        **Plugin URL:**
        ```
        https://github.com/${{ github.repository }}
        ```

        ### âœ¨ Features
        - ðŸ¤– 8 AI Providers (Ollama, OpenAI, Anthropic, Gemini, and more)
        - ðŸŽ¯ Library-aware recommendations
        - ðŸ’¾ Smart caching system
        - ðŸ”„ Automatic provider failover
        - ðŸ›¡ï¸ Enterprise-grade security

        ### ðŸ“‹ Requirements
        - **Lidarr Version:** 2.13.1.4681 or higher (plugins branch)
        - **.NET Version:** net6.0
        - **Docker Image:** `ghcr.io/hotio/lidarr:pr-plugins`

        ### ðŸ› Bug Reports
        Please report issues at: https://github.com/${{ github.repository }}/issues

        ### ðŸ“ Changelog
        See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for detailed changes.

        ---
        *Built with â¤ï¸ for the Lidarr community*
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: "Brainarr ${{ steps.version.outputs.version }}"
        body_path: release_notes.md
        files: |
          Brainarr-${{ steps.version.outputs.version }}.net6.0.zip
          Brainarr-${{ steps.version.outputs.version }}.net6.0.zip.sha256
        draft: false
        prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') }}

    - name: Summary
      run: |
        echo "## ðŸŽ‰ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Package:** Brainarr-${{ steps.version.outputs.version }}.net6.0.zip" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
        echo "https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
