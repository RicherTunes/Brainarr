name: Nightly

on:
  schedule:
    # Run at 6 AM UTC every day
    - cron: '0 6 * * *'
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  nightly-tests:
    name: Nightly Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-${{ matrix.dotnet-version }}
      cancel-in-progress: false

    strategy:
      fail-fast: false
      matrix:
        dotnet-version: ['6.0.x', '8.0.x']

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: false
        token: ${{ github.token }}

    - name: Init Common submodule
      uses: ./.github/actions/init-common-submodule
      with:
        token: ${{ secrets.SUBMODULES_TOKEN }}

    - name: Setup .NET ${{ matrix.dotnet-version }}
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: ${{ matrix.dotnet-version }}

    - name: Patch submodule NuGet mapping (TagLibSharp-Lidarr)
      shell: bash
      run: |
        set -euo pipefail
        CFG="ext/Lidarr.Plugin.Common/NuGet.config"
        if [ -f "$CFG" ]; then
          grep -q 'TagLibSharp-Lidarr' "$CFG" || \
            sed -i '/<packageSource key="lidarr-taglib">/a \      <package pattern="TagLibSharp-Lidarr*" />' "$CFG"
        fi

    - name: Extract Lidarr Assemblies
      shell: bash
      run: |
        timeout 15m bash scripts/extract-lidarr-assemblies.sh --mode full --no-tar-fallback --output-dir ext/Lidarr-docker/_output/net8.0
        echo "Extracted assemblies (sample):"
        ls -1 ext/Lidarr-docker/_output/net8.0 2>/dev/null | head -20 || true

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: |
        dotnet build --configuration Release --no-restore \
          -p:LidarrPath="${{ github.workspace }}/ext/Lidarr-docker/_output/net8.0" \
          -p:PluginPackagingDisable=true \
          -p:BuildInParallel=false \
          /nodeReuse:false \
          -m:1

    - name: Run Tests (all non-quarantined)
      run: |
        dotnet test --configuration Release --no-build \
          --verbosity normal \
          --filter "State!=Quarantined" \
          --blame-hang-timeout 120s \
          --logger "trx;LogFileName=test-results-${{ matrix.dotnet-version }}.trx" \
          --results-directory ./TestResults \
          -p:LidarrPath="${{ github.workspace }}/ext/Lidarr-docker/_output/net8.0"

    - name: Run quarantined tests (visibility - does not fail the build)
      # Near-instant when 0 tests match; ensures quarantined tests don't become invisible.
      if: always()
      continue-on-error: true
      run: |
        dotnet test --configuration Release --no-build \
          --verbosity normal \
          --filter "State=Quarantined" \
          --blame-hang-timeout 60s \
          --logger "trx;LogFileName=quarantined-${{ matrix.dotnet-version }}.trx" \
          --results-directory ./TestResults \
          -p:LidarrPath="${{ github.workspace }}/ext/Lidarr-docker/_output/net8.0"

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: nightly-test-results-${{ matrix.dotnet-version }}
        path: ./TestResults/*.trx
        retention-days: 7
