name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  DOTNET_VERSION: 8.0.404
  PLUGIN_VERSION: 1.0.${{ github.run_number }}
  LIDARR_DOCKER_VERSION: pr-plugins-2.13.3.4692

jobs:
  test:
    name: Test & Build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        dotnet-version: ['6.0.x', '8.0.x']
        
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ matrix.dotnet-version }}
        
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    - name: Extract Lidarr assemblies (Docker on Ubuntu, tar.gz fallback on others)
      run: |
        if [ "${{ runner.os }}" = "Linux" ]; then
          echo "ðŸ³ Extracting Lidarr assemblies from plugins branch Docker image (Ubuntu)..."
          
          # Use plugins branch Docker image (proven working approach)
          echo "Using Docker image: ghcr.io/hotio/lidarr:$LIDARR_DOCKER_VERSION"
          
          # Pull plugins branch Docker image
          docker pull ghcr.io/hotio/lidarr:$LIDARR_DOCKER_VERSION
          docker create --name temp-lidarr ghcr.io/hotio/lidarr:$LIDARR_DOCKER_VERSION
          
          # Create output directory
          mkdir -p ext/Lidarr-docker/_output/net6.0
          
          # Extract required assemblies directly from Docker container
          echo "ðŸ“¦ Extracting core Lidarr assemblies..."
          docker cp temp-lidarr:/app/bin/Lidarr.dll ext/Lidarr-docker/_output/net6.0/
          docker cp temp-lidarr:/app/bin/Lidarr.Common.dll ext/Lidarr-docker/_output/net6.0/
          docker cp temp-lidarr:/app/bin/Lidarr.Core.dll ext/Lidarr-docker/_output/net6.0/
          docker cp temp-lidarr:/app/bin/Lidarr.Http.dll ext/Lidarr-docker/_output/net6.0/
          docker cp temp-lidarr:/app/bin/Lidarr.Api.V1.dll ext/Lidarr-docker/_output/net6.0/
          
          # Extract Microsoft.Extensions assemblies (conditional)
          echo "ðŸ”§ Extracting Microsoft.Extensions assemblies..."
          docker cp temp-lidarr:/app/bin/Microsoft.Extensions.Caching.Memory.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || echo "âš  Microsoft.Extensions.Caching.Memory.dll not found"
          docker cp temp-lidarr:/app/bin/Microsoft.Extensions.Caching.Abstractions.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || echo "âš  Microsoft.Extensions.Caching.Abstractions.dll not found"
          docker cp temp-lidarr:/app/bin/Microsoft.Extensions.DependencyInjection.Abstractions.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || echo "âš  Microsoft.Extensions.DependencyInjection.Abstractions.dll not found"
          docker cp temp-lidarr:/app/bin/Microsoft.Extensions.Logging.Abstractions.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || echo "âš  Microsoft.Extensions.Logging.Abstractions.dll not found"
          docker cp temp-lidarr:/app/bin/Microsoft.Extensions.Options.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || echo "âš  Microsoft.Extensions.Options.dll not found"
          docker cp temp-lidarr:/app/bin/Microsoft.Extensions.Primitives.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || echo "âš  Microsoft.Extensions.Primitives.dll not found"
          
          # Extract additional assemblies that may be needed
          docker cp temp-lidarr:/app/bin/Lidarr.Host.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || echo "âš  Lidarr.Host.dll not found (optional)"
          
          # Cleanup Docker container
          docker rm temp-lidarr
          
          echo "âœ… Docker assembly extraction completed"
          echo "ðŸ“ Final assemblies in target directory:"
          ls -la ext/Lidarr-docker/_output/net6.0/
        else
          echo "ðŸ“¦ Extracting Lidarr assemblies from tar.gz (macOS/Windows fallback)..."
          
          # Create output directory
          mkdir -p ext/Lidarr-docker/_output/net6.0
          
          # Use latest stable Lidarr version for non-Linux platforms
          LIDARR_URL="https://github.com/Lidarr/Lidarr/releases/download/v2.12.4.4658/Lidarr.master.2.12.4.4658.linux-core-x64.tar.gz"
          echo "Downloading from: $LIDARR_URL"
          
          curl -L --retry 3 "$LIDARR_URL" -o lidarr.tar.gz
          
          if [ ! -f "lidarr.tar.gz" ]; then
            echo "Download failed"
            exit 1
          fi
          
          tar -xzf lidarr.tar.gz
          
          if [ -d "Lidarr" ]; then
            # Copy core Lidarr assemblies
            cp Lidarr/Lidarr.Core.dll ext/Lidarr-docker/_output/net6.0/
            cp Lidarr/Lidarr.Common.dll ext/Lidarr-docker/_output/net6.0/
            cp Lidarr/Lidarr.Http.dll ext/Lidarr-docker/_output/net6.0/
            cp Lidarr/Lidarr.Api.V1.dll ext/Lidarr-docker/_output/net6.0/
            
            # Copy Microsoft.Extensions assemblies with checks
            [ -f "Lidarr/Microsoft.Extensions.Caching.Memory.dll" ] && cp Lidarr/Microsoft.Extensions.Caching.Memory.dll ext/Lidarr-docker/_output/net6.0/
            [ -f "Lidarr/Microsoft.Extensions.Caching.Abstractions.dll" ] && cp Lidarr/Microsoft.Extensions.Caching.Abstractions.dll ext/Lidarr-docker/_output/net6.0/
            [ -f "Lidarr/Microsoft.Extensions.DependencyInjection.Abstractions.dll" ] && cp Lidarr/Microsoft.Extensions.DependencyInjection.Abstractions.dll ext/Lidarr-docker/_output/net6.0/
            [ -f "Lidarr/Microsoft.Extensions.Logging.Abstractions.dll" ] && cp Lidarr/Microsoft.Extensions.Logging.Abstractions.dll ext/Lidarr-docker/_output/net6.0/
            [ -f "Lidarr/Microsoft.Extensions.Options.dll" ] && cp Lidarr/Microsoft.Extensions.Options.dll ext/Lidarr-docker/_output/net6.0/
            [ -f "Lidarr/Microsoft.Extensions.Primitives.dll" ] && cp Lidarr/Microsoft.Extensions.Primitives.dll ext/Lidarr-docker/_output/net6.0/
            
            echo "âœ… Tar.gz assembly extraction completed"
            echo "ðŸ“ Final assemblies in target directory:"
            ls -la ext/Lidarr-docker/_output/net6.0/
          else
            echo "Extraction failed - Lidarr directory not found"
            exit 1
          fi
          
          rm -f lidarr.tar.gz
        fi
      shell: bash
      
    - name: Create CI project file (TypNull approach)
      run: |
        echo "ðŸ”§ Creating CI-optimized project file..."
        cat > Brainarr.CI.csproj << 'EOF'
        <Project Sdk="Microsoft.NET.Sdk">
          <PropertyGroup>
            <TargetFramework>net6.0</TargetFramework>
            <AssemblyName>Lidarr.Plugin.Brainarr</AssemblyName>
            <EnableDefaultCompileItems>false</EnableDefaultCompileItems>
            <LangVersion>latest</LangVersion>
            <Nullable>enable</Nullable>
            <WarningsAsErrors />
            <TreatWarningsAsErrors>true</TreatWarningsAsErrors>
            <WarningsNotAsErrors>NU1701;NU1702</WarningsNotAsErrors>
          </PropertyGroup>
          
          <ItemGroup>
            <Compile Include="Brainarr.Plugin/**/*.cs" />
          </ItemGroup>
          
          <!-- Essential NuGet packages only -->
          <ItemGroup>
            <PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
            <PackageReference Include="NLog" Version="5.4.0" />
            <PackageReference Include="FluentValidation" Version="9.5.4" />
          </ItemGroup>
          
          <!-- Docker-extracted Lidarr assemblies -->
          <ItemGroup>
            <Reference Include="Lidarr.Core">
              <HintPath>ext/Lidarr-docker/_output/net6.0/Lidarr.Core.dll</HintPath>
              <Private>false</Private>
            </Reference>
            <Reference Include="Lidarr.Common">
              <HintPath>ext/Lidarr-docker/_output/net6.0/Lidarr.Common.dll</HintPath>
              <Private>false</Private>
            </Reference>
            <Reference Include="Lidarr.Http">
              <HintPath>ext/Lidarr-docker/_output/net6.0/Lidarr.Http.dll</HintPath>
              <Private>false</Private>
            </Reference>
            <Reference Include="Lidarr.Api.V1">
              <HintPath>ext/Lidarr-docker/_output/net6.0/Lidarr.Api.V1.dll</HintPath>
              <Private>false</Private>
            </Reference>
          </ItemGroup>
        </Project>
        EOF
        echo "âœ… CI project file created"
      shell: bash
      
    - name: Set Lidarr Path
      run: echo "LIDARR_PATH=${{ github.workspace }}/ext/Lidarr-docker/_output/net6.0" >> $GITHUB_ENV
      shell: bash
      
    - name: Restore dependencies
      run: dotnet restore Brainarr.sln
      
    - name: Build (with fallback to CI project)
      run: |
        echo "ðŸ”¨ Attempting build with main solution..."
        if ! dotnet build Brainarr.sln --no-restore --configuration Release -p:LidarrPath="${{ github.workspace }}/ext/Lidarr-docker/_output/net6.0"; then
          echo "âš ï¸ Main build failed, trying with CI-optimized project..."
          dotnet restore Brainarr.CI.csproj
          dotnet build Brainarr.CI.csproj --configuration Release
        fi
      shell: bash
      
    - name: Test
      continue-on-error: true
      run: |
        echo "Running tests with better error handling..."
        mkdir -p TestResults
        dotnet test Brainarr.sln --no-build --configuration Release \
          --verbosity normal \
          --collect:"XPlat Code Coverage" \
          --logger "trx;LogFileName=test-results.trx" \
          --results-directory TestResults/ \
          --blame-hang-timeout 5m
      shell: bash
      
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.dotnet-version }}
        path: TestResults/
        if-no-files-found: warn
        
    - name: Package Plugin (Ubuntu only)
      if: matrix.os == 'ubuntu-latest' && matrix.dotnet-version == '6.0.x'
      run: |
        echo "Packaging plugin build artifacts..."
        mkdir -p artifacts
        
        # Copy built plugin files
        cp -r Brainarr.Plugin/bin/Release/net6.0/* artifacts/ 2>/dev/null || true
        
        # Copy plugin manifest
        cp plugin.json artifacts/
        
        # Create version info
        echo "Build Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" > artifacts/BUILD_INFO.txt
        echo "Git Commit: ${{ github.sha }}" >> artifacts/BUILD_INFO.txt
        echo "Git Branch: ${{ github.ref_name }}" >> artifacts/BUILD_INFO.txt
        echo "Runner OS: ${{ matrix.os }}" >> artifacts/BUILD_INFO.txt
        echo ".NET Version: ${{ matrix.dotnet-version }}" >> artifacts/BUILD_INFO.txt
        
        # Create artifact zip
        cd artifacts
        zip -r ../brainarr-ci-build-${{ github.run_number }}.zip .
        cd ..
        
    - name: Upload Build Artifacts
      if: matrix.os == 'ubuntu-latest' && matrix.dotnet-version == '6.0.x'
      uses: actions/upload-artifact@v4
      with:
        name: brainarr-build-${{ github.run_number }}
        path: |
          artifacts/
          brainarr-ci-build-${{ github.run_number }}.zip
        retention-days: 30
        
    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      if: matrix.os == 'ubuntu-latest' && matrix.dotnet-version == '6.0.x'
      with:
        file: TestResults/*/coverage.cobertura.xml
        flags: unittests
        name: codecov-umbrella
        token: ${{ secrets.CODECOV_TOKEN }}

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Run CodeQL Analysis
      uses: github/codeql-action/init@v3
      with:
        languages: csharp
        
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'
        
    - name: Extract Lidarr assemblies for security scan (Ubuntu only - Docker available)
      run: |
        echo "ðŸ³ Extracting Lidarr assemblies for security scan..."
        
        # Use plugins branch Docker image (same as main build)  
        docker pull ghcr.io/hotio/lidarr:$LIDARR_DOCKER_VERSION
        docker create --name temp-lidarr ghcr.io/hotio/lidarr:$LIDARR_DOCKER_VERSION
        
        # Create output directory
        mkdir -p ext/Lidarr-docker/_output/net6.0
        
        # Extract required assemblies
        docker cp temp-lidarr:/app/bin/Lidarr.dll ext/Lidarr-docker/_output/net6.0/
        docker cp temp-lidarr:/app/bin/Lidarr.Common.dll ext/Lidarr-docker/_output/net6.0/
        docker cp temp-lidarr:/app/bin/Lidarr.Core.dll ext/Lidarr-docker/_output/net6.0/
        docker cp temp-lidarr:/app/bin/Lidarr.Http.dll ext/Lidarr-docker/_output/net6.0/
        docker cp temp-lidarr:/app/bin/Lidarr.Api.V1.dll ext/Lidarr-docker/_output/net6.0/
        
        # Extract Microsoft.Extensions assemblies (conditional)
        docker cp temp-lidarr:/app/bin/Microsoft.Extensions.Caching.Memory.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || true
        docker cp temp-lidarr:/app/bin/Microsoft.Extensions.Caching.Abstractions.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || true
        docker cp temp-lidarr:/app/bin/Microsoft.Extensions.DependencyInjection.Abstractions.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || true
        docker cp temp-lidarr:/app/bin/Microsoft.Extensions.Logging.Abstractions.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || true
        docker cp temp-lidarr:/app/bin/Microsoft.Extensions.Options.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || true
        docker cp temp-lidarr:/app/bin/Microsoft.Extensions.Primitives.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || true
        
        # Extract optional assemblies
        docker cp temp-lidarr:/app/bin/Lidarr.Host.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || true
        
        # Cleanup Docker container
        docker rm temp-lidarr
        
        echo "âœ… Assemblies ready for security scan"
        
    - name: Set Lidarr Path
      run: echo "LIDARR_PATH=${{ github.workspace }}/ext/Lidarr-docker/_output/net6.0" >> $GITHUB_ENV
      
    - name: Build for Analysis
      run: |
        dotnet restore Brainarr.sln
        dotnet build Brainarr.sln --configuration Release -p:LidarrPath="${{ github.workspace }}/ext/Lidarr-docker/_output/net6.0"
        
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  build-plugin:
    name: Build Plugin Release
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'release'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'
        
    - name: Extract Lidarr assemblies for release (Ubuntu only - Docker available)
      run: |
        echo "ðŸ³ Extracting Lidarr assemblies for release build..."
        
        # Use plugins branch Docker image (same as main build)
        docker pull ghcr.io/hotio/lidarr:$LIDARR_DOCKER_VERSION
        docker create --name temp-lidarr ghcr.io/hotio/lidarr:$LIDARR_DOCKER_VERSION
        
        # Create output directory
        mkdir -p ext/Lidarr-docker/_output/net6.0
        
        # Extract required assemblies
        docker cp temp-lidarr:/app/bin/Lidarr.dll ext/Lidarr-docker/_output/net6.0/
        docker cp temp-lidarr:/app/bin/Lidarr.Common.dll ext/Lidarr-docker/_output/net6.0/
        docker cp temp-lidarr:/app/bin/Lidarr.Core.dll ext/Lidarr-docker/_output/net6.0/
        docker cp temp-lidarr:/app/bin/Lidarr.Http.dll ext/Lidarr-docker/_output/net6.0/
        docker cp temp-lidarr:/app/bin/Lidarr.Api.V1.dll ext/Lidarr-docker/_output/net6.0/
        
        # Extract Microsoft.Extensions assemblies (conditional)
        docker cp temp-lidarr:/app/bin/Microsoft.Extensions.Caching.Memory.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || true
        docker cp temp-lidarr:/app/bin/Microsoft.Extensions.Caching.Abstractions.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || true
        docker cp temp-lidarr:/app/bin/Microsoft.Extensions.DependencyInjection.Abstractions.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || true
        docker cp temp-lidarr:/app/bin/Microsoft.Extensions.Logging.Abstractions.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || true
        docker cp temp-lidarr:/app/bin/Microsoft.Extensions.Options.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || true
        docker cp temp-lidarr:/app/bin/Microsoft.Extensions.Primitives.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || true
        
        # Extract optional assemblies
        docker cp temp-lidarr:/app/bin/Lidarr.Host.dll ext/Lidarr-docker/_output/net6.0/ 2>/dev/null || true
        
        # Cleanup Docker container
        docker rm temp-lidarr
        
        echo "âœ… Assemblies ready for release build"
        
    - name: Build Plugin
      run: |
        dotnet restore Brainarr.sln
        dotnet build Brainarr.sln --configuration Release -p:LidarrPath="${{ github.workspace }}/ext/Lidarr-docker/_output/net6.0"
        
    - name: Create Release Package
      run: |
        mkdir -p release
        cp Brainarr.Plugin/bin/Lidarr.Plugin.Brainarr.dll release/
        cp plugin.json release/
        cp README.md release/
        cp LICENSE release/
        cd release
        zip -r ../Brainarr-${{ github.event.release.tag_name }}.zip .
        
    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./Brainarr-${{ github.event.release.tag_name }}.zip
        asset_name: Brainarr-${{ github.event.release.tag_name }}.zip
        asset_content_type: application/zip