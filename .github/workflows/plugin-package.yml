name: ðŸ“¦ Plugin Package

on:
  push:
    branches: [main]
    paths:
      - 'Brainarr.Plugin/**'
      - 'plugin.json'
      - 'manifest.json'
  workflow_dispatch:

permissions:
  contents: write  # Required for creating releases

jobs:
  package:
    name: Build Plugin Package
    runs-on: ubuntu-latest
    timeout-minutes: 45
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: false
        token: ${{ github.token }}

    - name: Init Common submodule
      uses: ./.github/actions/init-common-submodule
      with:
        token: ${{ secrets.SUBMODULES_TOKEN }}

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: '8.0.x'

    - name: Patch submodule NuGet mapping (TagLibSharp-Lidarr)
      shell: bash
      run: |
        set -euo pipefail
        CFG="ext/lidarr.plugin.common/NuGet.config"
        if [ -f "$CFG" ]; then
          echo "Patching $CFG to include TagLibSharp-Lidarr mapping..."
          grep -q 'TagLibSharp-Lidarr' "$CFG" || \
            sed -i '/<packageSource key="lidarr-taglib">/a \\      <package pattern="TagLibSharp-Lidarr*" />' "$CFG"
          echo "Done."
        else
          echo "No submodule NuGet.config found at $CFG"
        fi

    - name: Read pinned plugins digest (if available)
      id: digest
      shell: bash
      run: |
        if [ -f .github/lidarr_digest.txt ]; then
          DIG=$(cat .github/lidarr_digest.txt | tr -d '\n')
          if [[ "$DIG" == sha256:* ]]; then
            echo "LIDARR_DOCKER_DIGEST=$DIG" >> "$GITHUB_ENV"
            echo "Using pinned digest: $DIG"
          fi
        fi

    - name: Extract Lidarr Assemblies
      shell: bash
      run: |
        timeout 15m bash scripts/extract-lidarr-assemblies.sh --mode full --no-tar-fallback --output-dir ext/Lidarr-docker/_output/net8.0
        echo "Extracted assemblies (sample):"
        ls -1 ext/Lidarr-docker/_output/net8.0 | sed -n '1,40p'
        if [ ! -f ext/Lidarr-docker/_output/net8.0/NLog.dll ]; then
          echo "ERROR: NLog.dll missing from extracted assemblies; plugin may bind to wrong NLog version." >&2
          exit 1
        fi

    - name: Assemblies sanity check (script)
      shell: bash
      run: |
        bash scripts/ci/check-assemblies.sh ext/Lidarr-docker/_output/net8.0 --expect-tag "ghcr.io/hotio/lidarr:pr-plugins-2.14.2.4786"

    - name: Sanity check assemblies manifest
      shell: bash
      run: |
        set -euo pipefail
        MAN=ext/Lidarr-docker/_output/net8.0/MANIFEST.txt
        test -f "$MAN" || { echo "Missing MANIFEST.txt" >&2; exit 1; }
        echo "=== Assemblies MANIFEST (package) ==="; sed -n '1,80p' "$MAN"
        if grep -q '^Fallback:\s*tarball' "$MAN"; then
          echo "Assemblies came from tarball fallback; expected Docker (plugins branch)." >&2
          exit 1
        fi

    - name: Build Plugin
      shell: bash
      run: |
        dotnet restore Brainarr.Plugin/Brainarr.Plugin.csproj
        # serialize build to avoid GenerateDepsFile file locks in nested projects
        dotnet build Brainarr.Plugin/Brainarr.Plugin.csproj \
          --configuration Release \
          --no-restore \
          -p:LidarrPath="${{ github.workspace }}/ext/Lidarr-docker/_output/net8.0" \
          -m:1

    - name: Create Plugin Package
      shell: bash
      run: |
        # Create package staging directory with files at the root for direct deployment
        mkdir -p package

        # Copy plugin files into the package root so Lidarr sees them without an extra subfolder
        cp Brainarr.Plugin/bin/Lidarr.Plugin.Brainarr.dll package/        

        # Type identity assemblies (must ship as separate DLLs)
        host_out="ext/Lidarr-docker/_output/net8.0"
        for dep in \
          "Lidarr.Plugin.Abstractions.dll" \
          "Microsoft.Extensions.DependencyInjection.Abstractions.dll" \
          "Microsoft.Extensions.Logging.Abstractions.dll" \
          "FluentValidation.dll"; do
          if [ ! -f "$host_out/$dep" ]; then
            echo "ERROR: Required runtime dependency missing from extracted host assemblies: $dep" >&2
            echo "Build output sample:"
            ls -1 "$host_out" | sed -n '1,120p'
            exit 1
          fi
          cp "$host_out/$dep" package/
        done

        # Optional (allowed if present; can be internalized later)
        if [ -f "Brainarr.Plugin/bin/Lidarr.Plugin.Common.dll" ]; then
          cp "Brainarr.Plugin/bin/Lidarr.Plugin.Common.dll" package/
        fi
        cp plugin.json package/
        cp manifest.json package/
        cp .lidarr.plugin package/

        # Create latest.zip for direct download (files live at the package root)
        cd package
        zip -r ../Brainarr-latest.zip .
        cd ..

    - name: Validate ZIP contents (expected files)
      shell: bash
      run: |
        set -euo pipefail
        zipfile="Brainarr-latest.zip"
        unzip -l "$zipfile" | awk '{print $4}' | sed '/^$/d' | sort -u > ziplist.txt
        echo "ZIP contents:"; cat ziplist.txt
        for f in \
          "Lidarr.Plugin.Brainarr.dll" \
          "Lidarr.Plugin.Abstractions.dll" \
          "Microsoft.Extensions.DependencyInjection.Abstractions.dll" \
          "Microsoft.Extensions.Logging.Abstractions.dll" \
          "FluentValidation.dll" \
          "plugin.json" \
          "manifest.json" \
          ".lidarr.plugin"; do
          if ! grep -Fxq "$f" ziplist.txt; then
            echo "Missing expected file in ZIP: $f" >&2
            exit 1
          fi
        done

    - name: Validate packaging policy (unit tests)
      shell: pwsh
      env:
        REQUIRE_PACKAGE_TESTS: "true"
        PLUGIN_PACKAGE_PATH: "${{ github.workspace }}/Brainarr-latest.zip"
      run: |
        # Use unified test runner from Common with Packaging category
        $script = "ext/lidarr.plugin.common/scripts/test.ps1"
        if (Test-Path $script) {
          & $script -TestProject "Brainarr.Tests/Brainarr.Tests.csproj" `
            -Configuration Release -NoBuild -OutputDir TestResults/Packaging `
            -Category Packaging `
            -Properties @("LidarrPath=${{ github.workspace }}/ext/Lidarr-docker/_output/net8.0") -CI
        } else {
          Write-Error "FATAL: Unified test runner not found at $script"
          exit 1
        }

    - name: Upload Package Artifact
      uses: actions/upload-artifact@v4
      with:
        name: brainarr-latest
        path: |
          Brainarr-latest.zip
          package/
        retention-days: 7

  smoke:
    name: Plugin Smoke (Container Mount)
    runs-on: ubuntu-latest
    needs: package
    timeout-minutes: 30
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: false
        token: ${{ github.token }}

    - name: Download packaged artifact
      uses: actions/download-artifact@v4
      with:
        name: brainarr-latest
        path: plugin-dist

    - name: List artifact
      shell: bash
      run: |
        ls -la plugin-dist
        ls -la plugin-dist/package || true

    - name: Start Lidarr with plugin mounted
      shell: bash
      run: |
        set -e
        docker pull ghcr.io/hotio/lidarr:pr-plugins-2.14.2.4786
        docker run -d --name lidarr-smoke \
          -p 8686:8686 \
          -v "${{ github.workspace }}/plugin-dist/package:/config/plugins/RicherTunes/Brainarr:ro" \
          -e PUID=1000 -e PGID=1000 \
          ghcr.io/hotio/lidarr:pr-plugins-2.14.2.4786
        # Give it a moment to boot
        sleep 10
        echo "Container running: $(docker ps --filter name=lidarr-smoke --format '{{.Names}}')"

    - name: Verify plugin files are visible in container
      shell: bash
      run: |
        set -e
        docker exec lidarr-smoke ls -la /config/plugins/RicherTunes/Brainarr
        docker exec lidarr-smoke test -f /config/plugins/RicherTunes/Brainarr/Lidarr.Plugin.Brainarr.dll
        docker exec lidarr-smoke test -f /config/plugins/RicherTunes/Brainarr/plugin.json

    - name: Check discovery logs (best-effort)
      continue-on-error: true
      shell: bash
      run: |
        echo "Inspecting Lidarr logs for plugin discovery hints..."
        docker logs lidarr-smoke 2>&1 | rg -i "plugin|brainarr|import list" || echo "No explicit plugin discovery messages found"

    - name: Fetch API key from config and assert plugin via API
      continue-on-error: true
      shell: bash
      run: |
        set -e
        APIKEY=$(docker exec lidarr-smoke sh -lc "sed -n 's:.*<ApiKey>\\(.*\\)</ApiKey>.*:\\1:p' /config/config.xml")
        echo "Using API key: ${APIKEY:0:4}..."
        # wait for API to be ready and plugin to register
        for i in $(seq 1 30); do
          if curl -sS -H "X-Api-Key: $APIKEY" http://localhost:8686/api/v1/system/status >/dev/null 2>&1; then
            if curl -sS -H "X-Api-Key: $APIKEY" http://localhost:8686/api/v1/system/plugins | grep -qi Brainarr; then
              echo "Brainarr plugin detected via API"
              exit 0
            fi
          fi
          sleep 2
        done
        echo "Brainarr plugin not detected from Lidarr API after waiting" >&2
        exit 0

    - name: Assert Import List schema presence
      shell: bash
      run: |
        set -e
        APIKEY=$(docker exec lidarr-smoke sh -lc "sed -n 's:.*<ApiKey>\\(.*\\)</ApiKey>.*:\\1:p' /config/config.xml")
        echo "Checking Import List schema for Brainarr..."
        curl -sS -H "X-Api-Key: $APIKEY" http://localhost:8686/api/v1/importlist/schema | rg -i "Brainarr|AI Music Discovery"

    - name: Best-effort list fetch and log
      continue-on-error: true
      shell: bash
      run: |
        APIKEY=$(docker exec lidarr-smoke sh -lc "sed -n 's:.*<ApiKey>\\(.*\\)</ApiKey>.*:\\1:p' /config/config.xml")
        echo "Fetching current Import Lists (best-effort)"
        curl -sS -H "X-Api-Key: $APIKEY" http://localhost:8686/api/v1/importlist | head -c 4096 || true

    - name: Cleanup
      if: always()
      shell: bash
      run: |
        docker logs lidarr-smoke || true
        docker rm -f lidarr-smoke || true

    - name: Update Latest Pre-Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: latest
        name: "Latest Development Build"
        prerelease: true
        body: |
          ## ðŸ”„ Latest Development Build

          This is an automated build from the main branch.
          For stable releases, see the [releases page](https://github.com/${{ github.repository }}/releases).

          ### Installation

          **Via Lidarr UI:**
          1. Go to System â†’ Plugins
          2. Enter: `https://github.com/${{ github.repository }}`
          3. Click Install

          **Manual Installation:**
          Download and extract to your plugins folder.
        files: |
          Brainarr-latest.zip
