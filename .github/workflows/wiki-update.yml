name: ðŸ“š Wiki Auto-Update

# Automatically update wiki documentation when:
# 1. Release tags are pushed (version updates)  
# 2. Wiki content files are modified
# 3. Manual workflow dispatch

on:
  push:
    branches: [ main ]
    paths:
      - 'wiki-content/**'
      - 'README.md'
      - 'CHANGELOG.md'
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all wiki pages'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  update-wiki:
    name: ðŸ“– Sync Wiki Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ” Check Wiki Repository Exists
      id: wiki_check
      run: |
        # Test if wiki repository exists
        if git ls-remote https://github.com/${{ github.repository }}.wiki.git &>/dev/null; then
          echo "wiki_exists=true" >> $GITHUB_OUTPUT
          echo "âœ… Wiki repository exists"
        else
          echo "wiki_exists=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Wiki repository doesn't exist yet"
        fi
        
    - name: ðŸ“š Update Wiki Documentation
      if: steps.wiki_check.outputs.wiki_exists == 'true'
      run: |
        echo "ðŸ“š Updating wiki documentation..."
        
        # Determine update trigger
        if [ "${{ github.event_name }}" = "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${{ github.ref_name }}"
          echo "ðŸ·ï¸ Release-triggered wiki update for $VERSION"
          UPDATE_TYPE="release"
        elif [ "${{ github.event.inputs.force_update }}" = "true" ]; then
          echo "ðŸ”„ Force update triggered manually"
          UPDATE_TYPE="force"
        else
          echo "ðŸ“ Content change triggered wiki update"
          UPDATE_TYPE="content"
        fi
        
        # Clone wiki repository
        git clone https://github.com/${{ github.repository }}.wiki.git wiki-repo
        cd wiki-repo
        
        # Configure git for commits
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Copy updated wiki content
        echo "ðŸ”„ Syncing wiki content..."
        if [ -d "../wiki-content" ]; then
          cp ../wiki-content/*.md . 2>/dev/null || echo "No wiki content files to copy"
          
          # Handle file naming for GitHub Wiki (spaces instead of hyphens)
          for file in *.md; do
            if [[ "$file" == *"-"* ]]; then
              new_name=$(echo "$file" | sed 's/-/ /g')
              if [[ "$file" != "$new_name" ]]; then
                mv "$file" "$new_name"
                echo "ðŸ“„ Renamed: $file â†’ $new_name"
              fi
            fi
          done
        fi
        
        # Update version references for releases
        if [ "$UPDATE_TYPE" = "release" ]; then
          echo "ðŸ”„ Updating version references to $VERSION..."
          
          # Update all version references in wiki pages
          sed -i "s/v[0-9]\+\.[0-9]\+\.[0-9]\+/$VERSION/g" *.md 2>/dev/null || true
          sed -i "s/Brainarr-v[0-9]\+\.[0-9]\+\.[0-9]\+/Brainarr-$VERSION/g" *.md 2>/dev/null || true
          sed -i "s|download/v[0-9]\+\.[0-9]\+\.[0-9]\+/|download/$VERSION/|g" *.md 2>/dev/null || true
          
          # Update docker image references if this is a major release
          if [[ "$VERSION" == v*.*.0 ]]; then
            echo "ðŸ³ Major release detected - updating Docker image references"
            # Future: Update Docker image tags when Lidarr releases new plugin-enabled versions
          fi
        fi
        
        # Check for actual changes
        if git diff --quiet && git diff --cached --quiet; then
          echo "â„¹ï¸ No wiki changes detected - documentation is up to date"
        else
          echo "ðŸ“ Changes detected - updating wiki..."
          
          # Show what changed
          echo "ðŸ“‹ Changes detected:"
          git status --porcelain
          
          # Commit changes based on update type
          case $UPDATE_TYPE in
            release)
              COMMIT_MSG="docs: update wiki for release $VERSION

              â€¢ Updated version references throughout documentation
              â€¢ Updated download URLs to latest release
              â€¢ Synchronized installation instructions

              Automated update for release $VERSION"
              ;;
            content)  
              COMMIT_MSG="docs: sync wiki with latest content changes

              Automated wiki update from commit ${{ github.sha }}
              
              â€¢ Synchronized documentation with codebase changes
              â€¢ Updated based on latest implementation details
              â€¢ Maintained accuracy with source of truth
              
              Auto-updated by CI pipeline"
              ;;
            force)
              COMMIT_MSG="docs: force update wiki documentation

              Manual wiki refresh triggered by workflow dispatch
              
              â€¢ Complete documentation synchronization
              â€¢ Updated all pages with latest content
              â€¢ Ensured wiki accuracy with current codebase
              
              Manually triggered update"
              ;;
          esac
          
          git add .
          git commit -m "$COMMIT_MSG"
          git push origin master 2>/dev/null || git push origin main 2>/dev/null
          
          echo "âœ… Wiki updated successfully!"
          echo "ðŸ”— View updated wiki: https://github.com/${{ github.repository }}/wiki"
        fi
        
        cd ..
        rm -rf wiki-repo
        
    - name: ðŸ’¡ Wiki Setup Instructions
      if: steps.wiki_check.outputs.wiki_exists == 'false'
      run: |
        echo "ðŸ“˜ Wiki repository doesn't exist yet!"
        echo ""
        echo "ðŸš€ To enable automatic wiki updates:"
        echo "  1. Go to: https://github.com/${{ github.repository }}/wiki"
        echo "  2. Click 'Create the first page'"
        echo "  3. Copy content from wiki-content/Home.md in this repository"
        echo "  4. Save as 'Home'"
        echo "  5. Future updates will be automatic!"
        echo ""
        echo "âš¡ Or run locally: ./scripts/auto-upload-wiki.sh"

  build-plugin: