name: Submodule Pinning

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  verify-submodule-sha:
    name: Verify Submodule SHA
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: false

    - name: Init Common submodule
      uses: ./.github/actions/init-common-submodule
      with:
        token: ${{ secrets.SUBMODULES_TOKEN }}


    - name: Verify ext/Lidarr.Plugin.Common SHA
      shell: bash
      run: |
        set -euo pipefail

        expected=$(cat ext-common-sha.txt | tr -d '[:space:]')
        if [ -z "$expected" ]; then
          echo "ERROR: ext-common-sha.txt is empty" >&2
          exit 1
        fi

        status=$(git submodule status --recursive | grep 'ext/Lidarr.Plugin.Common' || true)
        if [ -z "$status" ]; then
          echo "ERROR: Submodule status not found for ext/Lidarr.Plugin.Common" >&2
          exit 1
        fi

        # Extract SHA (first field, strip any prefix like +/-)
        actual=$(echo "$status" | awk '{print $1}' | tr -d '+-')
        if [ -z "$actual" ]; then
          echo "ERROR: Failed to parse submodule SHA from: $status" >&2
          exit 1
        fi

        # Compare first 7 characters (short SHA)
        expected_short="${expected:0:7}"
        actual_short="${actual:0:7}"

        if [ "$expected_short" != "$actual_short" ]; then
          echo "ERROR: Submodule SHA mismatch!" >&2
          echo "  Expected: $expected" >&2
          echo "  Actual:   $actual" >&2
          echo "" >&2
          echo "To fix this, update ext-common-sha.txt with the new SHA:" >&2
          echo "  git submodule status ext/Lidarr.Plugin.Common | awk '{print \$1}' | tr -d '+-' > ext-common-sha.txt" >&2
          exit 1
        fi

        echo "Submodule SHA OK: $actual"
